{"version":3,"file":"xiaomairplane.umd.js","sources":["../src/application/status.js","../src/route/history.js","../src/application/apps.js"],"sourcesContent":["const AppStatus = {\r\n    MOUNTED : 'mounted',\r\n    BEFORE_BOOTSTRAP : 'before_bootstrap',\r\n    BOOTSTRAPPED : 'bootstrapped',\r\n    UNMOUNTED : 'unmounted'\r\n}\r\n\r\nexport default AppStatus","import {loadApps} from '../application/apps'\r\n\r\nconst originalPushState = window.history.pushState\r\nconst originalReplaceState = window.history.replaceState\r\n\r\nexport function overwriteEventsAndHistory(){\r\n    window.history.pushState = (state ,title ,url)=>{\r\n        const result = originalPushState.call(this,state,title,url)\r\n        loadApps()\r\n        return result\r\n    }\r\n\r\n    window.history.replaceState = (state ,title ,url)=>{\r\n        const result = originalReplaceState.call(this ,state ,title ,url)\r\n        loadApps()\r\n        return result\r\n    }\r\n\r\n    window.addEventListener('popstate' ,()=>{\r\n        loadApps()\r\n    } ,true)\r\n\r\n    window.addEventListener('hashchange' ,()=>{\r\n        loadApps()\r\n    } ,true)\r\n}","import AppStatus from './status'\r\nimport {overwriteEventsAndHistory} from '../route/history'\r\n\r\nconst appsMapping = {}\r\n\r\nexport async function loadApps(){\r\n    //先卸载所有失活的子应用\r\n    const toUnMountApp = getAppsWithStatus(AppStatus.MOUNTED)\r\n    await Promise.all(toUnMountApp.map(unMountApp))\r\n\r\n    // 初始化所有刚注册的子应用\r\n    const toLoadApp = getAppsWithStatus(AppStatus.BEFORE_BOOTSTRAP)\r\n    await Promise.all(toLoadApp.map(bootstrapApp))\r\n\r\n    // 加载所有符合条件的子应用\r\n    const toMountApp = [\r\n        ...getAppsWithStatus(AppStatus.BOOTSTRAPPED),\r\n        ...getAppsWithStatus(AppStatus.UNMOUNTED)\r\n    ]\r\n\r\n    // 加载所有符合条件的子应用\r\n    await Promise.all(toMountApp.map(mountApp))\r\n}\r\n\r\nexport function registerApplication(application){\r\n    appsMapping[application.name] = {\r\n                                        application : application ,\r\n                                        status : AppStatus.BEFORE_BOOTSTRAP\r\n                                    }\r\n}\r\n\r\nexport function getAppsWithStatus(appStatus){\r\n    let res = []\r\n    let keys = Object.keys(appsMapping)\r\n    keys.forEach((key)=>{\r\n        if (appsMapping[key].status == appStatus){\r\n            res.push(appsMapping[key].application.loadApp())\r\n        }\r\n    })\r\n\r\n    return res\r\n}\r\n\r\nexport function start(){\r\n    overwriteEventsAndHistory()\r\n    loadApps()\r\n}\r\n\r\nfunction bootstrapApp(app){\r\n    app.then(tmp =>{\r\n        tmp.bootstrap()\r\n        // 状态置为BOOTSTRAP\r\n        appsMapping[tmp.name].status = AppStatus.BOOTSTRAPPED\r\n    })\r\n}\r\n\r\nfunction mountApp(app){\r\n    // 判断当前url\r\n    app.then(tmp =>{\r\n        if (appsMapping[tmp.name].application.activeRule(window.location)){\r\n            tmp.mount()\r\n            // 状态设置为MOUNTED\r\n            appsMapping[tmp.name].status = AppStatus.MOUNTED\r\n        }\r\n    })\r\n}\r\n\r\nfunction unMountApp(app){\r\n    // 判断当前url\r\n    app.then(tmp =>{\r\n        if (!appsMapping[tmp.name].application.activeRule(window.location)){\r\n            tmp.unmount()\r\n            // 状态设置为UNMOUNTED\r\n            appsMapping[tmp.name].status = AppStatus.UNMOUNTED\r\n        }\r\n    })\r\n}"],"names":["AppStatus","originalPushState","originalReplaceState","overwriteEventsAndHistory","state","title","url","result","loadApps","appsMapping","toUnMountApp","getAppsWithStatus","unMountApp","toLoadApp","bootstrapApp","toMountApp","mountApp","registerApplication","application","appStatus","res","key","start","app","tmp"],"mappings":"kOAAA,MAAMA,EAAY,CACd,QAAU,UACV,iBAAmB,mBACnB,aAAe,eACf,UAAY,WAChB,ECHMC,EAAoB,OAAO,QAAQ,UACnCC,EAAuB,OAAO,QAAQ,aAErC,SAASC,GAA2B,CACvC,OAAO,QAAQ,UAAY,CAACC,EAAOC,EAAOC,IAAM,CAC5C,MAAMC,EAASN,EAAkB,KAAK,KAAKG,EAAMC,EAAMC,CAAG,EAC1D,OAAAE,EAAU,EACHD,CACV,EAED,OAAO,QAAQ,aAAe,CAACH,EAAOC,EAAOC,IAAM,CAC/C,MAAMC,EAASL,EAAqB,KAAK,KAAME,EAAOC,EAAOC,CAAG,EAChE,OAAAE,EAAU,EACHD,CACV,EAED,OAAO,iBAAiB,WAAY,IAAI,CACpCC,EAAU,CACb,EAAE,EAAI,EAEP,OAAO,iBAAiB,aAAc,IAAI,CACtCA,EAAU,CACb,EAAE,EAAI,CACX,CCtBA,MAAMC,EAAc,CAAE,EAEf,eAAeD,GAAU,CAE5B,MAAME,EAAeC,EAAkBX,EAAU,OAAO,EACxD,MAAM,QAAQ,IAAIU,EAAa,IAAIE,CAAU,CAAC,EAG9C,MAAMC,EAAYF,EAAkBX,EAAU,gBAAgB,EAC9D,MAAM,QAAQ,IAAIa,EAAU,IAAIC,CAAY,CAAC,EAG7C,MAAMC,EAAa,CACf,GAAGJ,EAAkBX,EAAU,YAAY,EAC3C,GAAGW,EAAkBX,EAAU,SAAS,CAC3C,EAGD,MAAM,QAAQ,IAAIe,EAAW,IAAIC,CAAQ,CAAC,CAC9C,CAEO,SAASC,EAAoBC,EAAY,CAC5CT,EAAYS,EAAY,IAAI,EAAI,CACI,YAAcA,EACd,OAASlB,EAAU,gBACtB,CACrC,CAEO,SAASW,EAAkBQ,EAAU,CACxC,IAAIC,EAAM,CAAE,EAEZ,OADW,OAAO,KAAKX,CAAW,EAC7B,QAASY,GAAM,CACZZ,EAAYY,CAAG,EAAE,QAAUF,GAC3BC,EAAI,KAAKX,EAAYY,CAAG,EAAE,YAAY,SAAS,CAE3D,CAAK,EAEMD,CACX,CAEO,SAASE,GAAO,CACnBnB,EAA2B,EAC3BK,EAAU,CACd,CAEA,SAASM,EAAaS,EAAI,CACtBA,EAAI,KAAKC,GAAM,CACXA,EAAI,UAAW,EAEff,EAAYe,EAAI,IAAI,EAAE,OAASxB,EAAU,YACjD,CAAK,CACL,CAEA,SAASgB,EAASO,EAAI,CAElBA,EAAI,KAAKC,GAAM,CACPf,EAAYe,EAAI,IAAI,EAAE,YAAY,WAAW,OAAO,QAAQ,IAC5DA,EAAI,MAAO,EAEXf,EAAYe,EAAI,IAAI,EAAE,OAASxB,EAAU,QAErD,CAAK,CACL,CAEA,SAASY,EAAWW,EAAI,CAEpBA,EAAI,KAAKC,GAAM,CACNf,EAAYe,EAAI,IAAI,EAAE,YAAY,WAAW,OAAO,QAAQ,IAC7DA,EAAI,QAAS,EAEbf,EAAYe,EAAI,IAAI,EAAE,OAASxB,EAAU,UAErD,CAAK,CACL"}