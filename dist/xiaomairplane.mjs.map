{"version":3,"file":"xiaomairplane.mjs","sources":["../src/application/status.js","../src/route/history.js","../src/application/apps.js"],"sourcesContent":["const AppStatus = {\r\n    MOUNTED : 'mounted',\r\n    BEFORE_BOOTSTRAP : 'before_bootstrap',\r\n    BOOTSTRAPPED : 'bootstrapped',\r\n    UNMOUNTED : 'unmounted'\r\n}\r\n\r\nexport default AppStatus","import {loadApps} from '../application/apps'\r\n\r\nconst originalPushState = window.history.pushState\r\nconst originalReplaceState = window.history.replaceState\r\n\r\nexport function overwriteEventsAndHistory(){\r\n    window.history.pushState = (state ,title ,url)=>{\r\n        const result = originalPushState.call(this,state,title,url)\r\n        loadApps()\r\n        return result\r\n    }\r\n\r\n    window.history.replaceState = (state ,title ,url)=>{\r\n        const result = originalReplaceState.call(this ,state ,title ,url)\r\n        loadApps()\r\n        return result\r\n    }\r\n\r\n    window.addEventListener('popstate' ,()=>{\r\n        loadApps()\r\n    } ,true)\r\n\r\n    window.addEventListener('hashchange' ,()=>{\r\n        loadApps()\r\n    } ,true)\r\n}","import AppStatus from './status'\r\nimport {overwriteEventsAndHistory} from '../route/history'\r\n\r\nconst appsMapping = {}\r\n\r\nexport async function loadApps(){\r\n    //先卸载所有失活的子应用\r\n    const toUnMountApp = getAppsWithStatus(AppStatus.MOUNTED)\r\n    await Promise.all(toUnMountApp.map(unMountApp))\r\n\r\n    // 初始化所有刚注册的子应用\r\n    const toLoadApp = getAppsWithStatus(AppStatus.BEFORE_BOOTSTRAP)\r\n    await Promise.all(toLoadApp.map(bootstrapApp))\r\n\r\n    // 加载所有符合条件的子应用\r\n    const toMountApp = [\r\n        ...getAppsWithStatus(AppStatus.BOOTSTRAPPED),\r\n        ...getAppsWithStatus(AppStatus.UNMOUNTED)\r\n    ]\r\n\r\n    // 加载所有符合条件的子应用\r\n    await Promise.all(toMountApp.map(mountApp))\r\n}\r\n\r\nexport function registerApplication(application){\r\n    appsMapping[application.name] = {\r\n                                        application : application ,\r\n                                        status : AppStatus.BEFORE_BOOTSTRAP\r\n                                    }\r\n}\r\n\r\nexport function getAppsWithStatus(appStatus){\r\n    let res = []\r\n    let keys = Object.keys(appsMapping)\r\n    keys.forEach((key)=>{\r\n        if (appsMapping[key].status == appStatus){\r\n            res.push(appsMapping[key].application.loadApp())\r\n        }\r\n    })\r\n\r\n    return res\r\n}\r\n\r\nexport function start(){\r\n    overwriteEventsAndHistory()\r\n    loadApps()\r\n}\r\n\r\nfunction bootstrapApp(app){\r\n    app.then(tmp =>{\r\n        tmp.bootstrap()\r\n        // 状态置为BOOTSTRAP\r\n        appsMapping[tmp.name].status = AppStatus.BOOTSTRAPPED\r\n    })\r\n}\r\n\r\nfunction mountApp(app){\r\n    // 判断当前url\r\n    app.then(tmp =>{\r\n        if (appsMapping[tmp.name].application.activeRule(window.location)){\r\n            tmp.mount()\r\n            // 状态设置为MOUNTED\r\n            appsMapping[tmp.name].status = AppStatus.MOUNTED\r\n        }\r\n    })\r\n}\r\n\r\nfunction unMountApp(app){\r\n    // 判断当前url\r\n    app.then(tmp =>{\r\n        if (!appsMapping[tmp.name].application.activeRule(window.location)){\r\n            tmp.unmount()\r\n            // 状态设置为UNMOUNTED\r\n            appsMapping[tmp.name].status = AppStatus.UNMOUNTED\r\n        }\r\n    })\r\n}"],"names":["AppStatus","originalPushState","originalReplaceState","overwriteEventsAndHistory","state","title","url","result","loadApps","appsMapping","toUnMountApp","getAppsWithStatus","unMountApp","toLoadApp","bootstrapApp","toMountApp","mountApp","registerApplication","application","appStatus","res","key","start","app","tmp"],"mappings":"AAAA,MAAMA,IAAY;AAAA,EACd,SAAU;AAAA,EACV,kBAAmB;AAAA,EACnB,cAAe;AAAA,EACf,WAAY;AAChB,GCHMC,IAAoB,OAAO,QAAQ,WACnCC,IAAuB,OAAO,QAAQ;AAErC,SAASC,IAA2B;AACvC,SAAO,QAAQ,YAAY,CAACC,GAAOC,GAAOC,MAAM;AAC5C,UAAMC,IAASN,EAAkB,KAAK,MAAKG,GAAMC,GAAMC,CAAG;AAC1D,WAAAE,EAAU,GACHD;AAAA,EACV,GAED,OAAO,QAAQ,eAAe,CAACH,GAAOC,GAAOC,MAAM;AAC/C,UAAMC,IAASL,EAAqB,KAAK,MAAME,GAAOC,GAAOC,CAAG;AAChE,WAAAE,EAAU,GACHD;AAAA,EACV,GAED,OAAO,iBAAiB,YAAY,MAAI;AACpC,IAAAC,EAAU;AAAA,EACb,GAAE,EAAI,GAEP,OAAO,iBAAiB,cAAc,MAAI;AACtC,IAAAA,EAAU;AAAA,EACb,GAAE,EAAI;AACX;ACtBA,MAAMC,IAAc,CAAE;AAEf,eAAeD,IAAU;AAE5B,QAAME,IAAeC,EAAkBX,EAAU,OAAO;AACxD,QAAM,QAAQ,IAAIU,EAAa,IAAIE,CAAU,CAAC;AAG9C,QAAMC,IAAYF,EAAkBX,EAAU,gBAAgB;AAC9D,QAAM,QAAQ,IAAIa,EAAU,IAAIC,CAAY,CAAC;AAG7C,QAAMC,IAAa;AAAA,IACf,GAAGJ,EAAkBX,EAAU,YAAY;AAAA,IAC3C,GAAGW,EAAkBX,EAAU,SAAS;AAAA,EAC3C;AAGD,QAAM,QAAQ,IAAIe,EAAW,IAAIC,CAAQ,CAAC;AAC9C;AAEO,SAASC,EAAoBC,GAAY;AAC5C,EAAAT,EAAYS,EAAY,IAAI,IAAI;AAAA,IACI,aAAcA;AAAA,IACd,QAASlB,EAAU;AAAA,EACtB;AACrC;AAEO,SAASW,EAAkBQ,GAAU;AACxC,MAAIC,IAAM,CAAE;AAEZ,SADW,OAAO,KAAKX,CAAW,EAC7B,QAAQ,CAACY,MAAM;AAChB,IAAIZ,EAAYY,CAAG,EAAE,UAAUF,KAC3BC,EAAI,KAAKX,EAAYY,CAAG,EAAE,YAAY,SAAS;AAAA,EAE3D,CAAK,GAEMD;AACX;AAEO,SAASE,IAAO;AACnB,EAAAnB,EAA2B,GAC3BK,EAAU;AACd;AAEA,SAASM,EAAaS,GAAI;AACtB,EAAAA,EAAI,KAAK,CAAAC,MAAM;AACX,IAAAA,EAAI,UAAW,GAEff,EAAYe,EAAI,IAAI,EAAE,SAASxB,EAAU;AAAA,EACjD,CAAK;AACL;AAEA,SAASgB,EAASO,GAAI;AAElB,EAAAA,EAAI,KAAK,CAAAC,MAAM;AACX,IAAIf,EAAYe,EAAI,IAAI,EAAE,YAAY,WAAW,OAAO,QAAQ,MAC5DA,EAAI,MAAO,GAEXf,EAAYe,EAAI,IAAI,EAAE,SAASxB,EAAU;AAAA,EAErD,CAAK;AACL;AAEA,SAASY,EAAWW,GAAI;AAEpB,EAAAA,EAAI,KAAK,CAAAC,MAAM;AACX,IAAKf,EAAYe,EAAI,IAAI,EAAE,YAAY,WAAW,OAAO,QAAQ,MAC7DA,EAAI,QAAS,GAEbf,EAAYe,EAAI,IAAI,EAAE,SAASxB,EAAU;AAAA,EAErD,CAAK;AACL;"}